@model ExpenseTracker.Models.AddExpenseViewModel
@{
    ViewData["Title"] = "Add Expense";
}

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-7">
            <div class="text-center mb-4">
                <h2 class="fw-bold" style="letter-spacing: -0.03em;">Log New Transaction</h2>
                <p class="text-muted small">Record shared expenses, define participants, and track payments.</p>
            </div>

            <div class="card-minimal p-4">
                <form id="expenseForm">

                    <div class="mb-4">
                        <label asp-for="Title" class="form-label">Description</label>
                        <input asp-for="Title" id="Title" class="form-control-minimal" placeholder="Dinner, Uber, Groceries..." required />
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label asp-for="Amount" class="form-label">Total Amount (â‚¬)</label>
                            <input asp-for="Amount" id="Amount" type="number" step="0.01" class="form-control-minimal" placeholder="0.00" required />
                        </div>
                        <div class="col-md-4">
                            <label asp-for="Date" class="form-label">Date</label>
                            <input asp-for="Date" id="Date" type="date" class="form-control-minimal" required />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Split Method</label>
                            <select id="SplitType" class="form-control-minimal">
                                <option value="0">Equal Split</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-5 p-3" style="border: 1px solid var(--border-color); border-radius: 4px;">
                        <label class="form-label mb-3 fw-bold">Participants</label>
                        
                        <table class="table table-borderless table-sm mb-2" id="participantsTable">
                            <thead>
                                <tr class="border-bottom" style="font-size: 0.85rem; color: var(--color-gray);">
                                    <th>PARTICIPANT USERNAME</th>
                                    <th style="width: 50px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                        
                        <button type="button" class="btn btn-outline-dark btn-sm mt-3" id="addParticipantBtn">
                            + Add Participant
                        </button>
                    </div>

                    <div id="errorSummary" class="alert alert-danger py-2 small mb-4 d-none"></div>

                    <button type="submit" class="btn btn-primary-minimal w-100">
                        <i class="bi bi-check-lg me-2"></i> Save Expense
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        
        const currentUser = "@Context.Session.GetString("Username")";
        const expenseForm = document.getElementById('expenseForm');
        const participantsTableBody = document.querySelector("#participantsTable tbody");
        const errorBox = document.getElementById('errorSummary');

        
        function addParticipantRow(username = "", isFixed = false) {
            const row = document.createElement("tr");

            row.innerHTML = `
                <td>
                    <input class="form-control-minimal form-control-sm username-input" 
                           value="${username}" 
                           ${isFixed ? 'readonly style="background-color: #f8f9fa; color: #6c757d;"' : ''} 
                           placeholder="username" required />
                </td>
                <td class="align-middle text-center">
                    ${isFixed ? 
                        '<span class="badge bg-light text-dark border">You</span>' : 
                        '<button type="button" class="btn btn-sm btn-outline-danger removeBtn" style="width: 30px;">&times;</button>'}
                </td>
            `;
            
            participantsTableBody.appendChild(row);

            // Attach delete event if not the owner
            if (!isFixed) {
                row.querySelector(".removeBtn").addEventListener("click", () => row.remove());
            }
        }

        
        document.addEventListener("DOMContentLoaded", () => {
            // Clear table and add the owner
            participantsTableBody.innerHTML = "";
            addParticipantRow(currentUser, true);
        });

        // Add Participant Button click handler
        document.getElementById("addParticipantBtn").addEventListener("click", () => {
            addParticipantRow();
        });

        //Form Submission
        expenseForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            errorBox.classList.add('d-none');
            errorBox.innerHTML = '';

            const participantRows = document.querySelectorAll("#participantsTable tbody tr");
            const participants = Array.from(participantRows).map(row => ({
                username: row.querySelector(".username-input").value.trim()
            }));

            const payload = {
                title: document.getElementById('Title').value,
                amount: parseFloat(document.getElementById('Amount').value),
                date: document.getElementById('Date').value,
                splitType: 0, // Equal Split
                participants: participants
            };

            try {
                const response = await fetch('/api/expenseapi', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    // Status 201 Created
                    window.location.href = '/Expense/Index';
                } else {
                    const data = await response.json();
                    errorBox.innerHTML = data.message || "An error occurred while saving the expense.";
                    errorBox.classList.remove('d-none');
                }
            } catch (err) {
                console.error("Fetch error:", err);
                errorBox.innerHTML = "Connection to server failed. Please try again.";
                errorBox.classList.remove('d-none');
            }
        });
    </script>
}