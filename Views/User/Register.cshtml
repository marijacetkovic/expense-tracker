@model ExpenseTracker.Models.RegisterViewModel
@{
    ViewData["Title"] = "Register";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-5 col-lg-4">

            <div class="text-center mb-4">
                <h2 class="fw-bold" style="letter-spacing: -0.03em;">Create Your Account</h2>
                <p class="text-muted small">Start tracking your expenses with precision.</p>
            </div>

            <div class="card-minimal">
                <form id="registerForm">
                    
                    <div class="mb-4">
                        <label asp-for="Username" class="form-label"></label>
                        <input asp-for="Username" id="Username" class="form-control-minimal" placeholder="e.g. johndoe" required />
                        <span asp-validation-for="Username" class="text-danger small mt-1 d-block"></span>
                    </div>

                    <div class="mb-4">
                        <label asp-for="Email" class="form-label"></label>
                        <input asp-for="Email" id="Email" class="form-control-minimal" placeholder="you@example.com" required />
                        <span asp-validation-for="Email" class="text-danger small mt-1 d-block"></span>
                    </div>

                    <div class="mb-4">
                        <label asp-for="Password" class="form-label"></label>
                        <input asp-for="Password" id="Password" class="form-control-minimal" type="password" placeholder="••••••••" required />
                        <span asp-validation-for="Password" class="text-danger small mt-1 d-block"></span>
                    </div>

                    <div class="mb-4">
                        <label asp-for="ConfirmPassword" class="form-label">Confirm Password</label>
                        <input asp-for="ConfirmPassword" id="ConfirmPassword" class="form-control-minimal" type="password" placeholder="••••••••" required />
                        <span asp-validation-for="ConfirmPassword" class="text-danger small mt-1 d-block"></span>
                    </div>
                    
                    <div id="errorSummary" class="alert alert-danger py-2 small mb-4 d-none"></div>

                    <button type="submit" class="btn btn-primary-minimal w-100">
                        Create Account
                    </button>
                </form>
            </div>

            <p class="text-center mt-4 small text-muted">
                Already have an account? 
                <a asp-controller="User" asp-action="Login" class="text-dark fw-bold text-decoration-none border-bottom border-dark">Login here</a>
            </p>
        </div>
    </div>
</div>

<script>
    document.getElementById('registerForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const errorBox = document.getElementById('errorSummary');
        const pass = document.getElementById('Password').value;
        const confirmPass = document.getElementById('ConfirmPassword').value;

        errorBox.classList.add('d-none');
        errorBox.innerHTML = '';

        // Basic client-side check before hitting the API
        if (pass !== confirmPass) {
            errorBox.innerHTML = "Passwords do not match.";
            errorBox.classList.remove('d-none');
            return;
        }

        const payload = {
            username: document.getElementById('Username').value,
            email: document.getElementById('Email').value,
            password: pass,
            confirmPassword: confirmPass
        };

        try {
            const response = await fetch('/api/userapi/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.status === 201) {
                // Success! Redirect to login
                window.location.href = '/User/Login';
            } else {
                // Handles 400 (Validation) and 409 (Conflict)
                const data = await response.json();
                
                if (data.errors) {
                    // Handle validation object from [ApiController]
                    errorBox.innerHTML = "Please check your input data.";
                } else {
                    errorBox.innerHTML = data.message || "Registration failed.";
                }
                errorBox.classList.remove('d-none');
            }
        } catch (error) {
            errorBox.innerHTML = "Could not connect to the server.";
            errorBox.classList.remove('d-none');
        }
    });
</script>